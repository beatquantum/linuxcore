# /etc/nginx/nginx.conf
# Author: Santosh Pandit
# Objective 1: Implement modern practices for 2025
# Objective 2: Defend against highly sophisticated attacks
# Note 1: $badagent is defined in /etc/nginx/conf.d/badagent.conf
# Note 2: $allowed_country is defined in /etc/nginx/conf.d/geoblocking.conf
# Note 3: $loggable is defined in /etc/nginx/conf.d/loggable.conf
# Note 4: The required nginx-extra modules are available from n.wtf composition
# ============================================================================
# Main Configuration
# ============================================================================
user www-data; # Potentially replace with nginx or http for other OS/nginx.
worker_processes auto;
pid /run/nginx.pid;
worker_rlimit_nofile 65535;
error_log /var/log/nginx/error.log error;
include /etc/nginx/modules-enabled/*.conf;
# ============================================================================
# Events Configuration
# ============================================================================
events {
    worker_connections 8192;
    multi_accept on;
    use epoll;
}
# ============================================================================
# HTTP Configuration
# ============================================================================
http {
    # Basic Settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    default_type text/plain;
    charset utf-8;
    ssi on; # Very important
    # MIME Types
    include mime.types;
    types_hash_max_size 4096;
    charset_types text/xml text/plain text/vnd.wap.wml application/javascript application/rss+xml;
    # File Handling
    index index.php index.html;
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
    # Client Request Handling
    # Configure client body and header buffers (optimized for 2GB RAM)
    client_body_buffer_size 16k;
    client_header_buffer_size 2k;
    client_max_body_size 8M;
    large_client_header_buffers 4 8k;
    client_body_temp_path /tmp/nginx_client_temp 1 2;
    # Timeout settings to mitigate Slowloris-type attacks
    client_body_timeout 30s;
    client_header_timeout 5s;
    send_timeout 60s;
    reset_timedout_connection on;
    keepalive_timeout 15s;
    keepalive_requests 128;
    # DOS Prevention
    # Connection limiting per IP and server
    limit_conn_zone $binary_remote_addr zone=perip:16m;
    limit_conn_zone $server_name zone=perserver:16m;
    limit_conn perip 64;
    limit_conn perserver 16384;
    limit_conn_log_level error;
    limit_conn_status 429;
    # Request rate limiting per IP
    limit_req_zone $binary_remote_addr zone=req_limit_per_ip:16m rate=32r/s;
    limit_req zone=req_limit_per_ip burst=64 nodelay;
    limit_req_status 429;
    # Caching
    open_file_cache max=256 inactive=60m;
    open_file_cache_valid 60m;
    open_file_cache_min_uses 1;
    open_file_cache_errors off;
    # Compression - disable globally - enable in non-sensitive location or server blocks
    gzip off;
    gzip_comp_level 6;
    gzip_types text/css text/plain application/javascript application/xml application/json image/svg+xml application/rss+xml application/atom+xml;
    gzip_min_length 256;
    gzip_vary off;
    brotli off;
    brotli_types text/css text/plain application/javascript application/xml;
    brotli_min_length 256;
    # SSL/TLS Configuration - Optimised by Santosh Pandit - Do not change!
    ssl_protocols TLSv1.3 TLSv1.2;
    ssl_ciphers ECDH+CHACHA20:ECDH+AESGCM+AES256;
    ssl_conf_command Ciphersuites TLS_CHACHA20_POLY1305_SHA256:TLS_AES_256_GCM_SHA384;
    ssl_conf_command Options ServerPreference,PrioritizeChaCha,NoRenegotiation,NoResumptionOnRenegotiation;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_buffer_size 8k;
    ssl_early_data off;
    ssl_session_tickets on;
    # Disable SSL stapling as it's no longer supported by Let's Encrypt
    ssl_stapling off;
    ssl_stapling_verify off;
    # ECC curves with post-quantum cryptography support
    ssl_ecdh_curve MLKEM1024:MLKEM768:MLKEM512:SecP384r1MLKEM1024:SecP256r1MLKEM768:X25519MLKEM768:secp521r1:secp384r1:x448:secp256r1:x25519;
    # HTTP/2 Optimization
    http2 on;
    http2_body_preread_size 64k;
    http2_chunk_size 16k;
    http2_max_concurrent_streams 256;
    http2_recv_buffer_size 512k;
    # HTTP/3 (QUIC) Optimization
    http3 on;
    http3_stream_buffer_size 8k;
    http3_max_concurrent_streams 128;
    quic_active_connection_id_limit 16;
    quic_gso on;
    quic_retry on;
    # Note: For QUIC/HTTP/3, ensure /etc/nginx/ssl/quic_host.key is generated separately (e.g., openssl genpkey -algorithm X25519 -out /etc/nginx/ssl/quic_host.key)
    # Security Settings
    # Prevent information leakage
    server_tokens off;
    etag off;
    # Disable directory listing and range requests
    autoindex off;
    max_ranges 0;
    # DNS Resolver Configuration
    resolver 1.1.1.1 1.0.0.1 8.8.8.8 [2606:4700:4700::1111] [2606:4700:4700::1001] valid=300s ipv6=on;
    resolver_timeout 5s;
    # Custom Logging
    # Define $log_errors variable if needed (e.g., in a conf.d file: map $status $log_errors { default 0; ~[4-5] 1; }
    log_format custom '[$time_local] $remote_addr|$http_x_forwarded_for|$status|$host|$http_user_agent|$http_cookie|$args|$request_time|$content_length|$http_origin|$http_referer|$http_x_forwarded_proto|$ssl_protocol|$ssl_cipher|$request_length|$request';
    access_log /var/log/nginx/access.log custom if=$log_errors;
}
